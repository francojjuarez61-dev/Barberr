<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BarberApp - Gesti√≥n Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Modificado para soportar el fix de scroll */
        body.no-scroll { overflow: hidden; position: fixed; width: 100%; height: 100vh; }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-input:focus {
            background: rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
        }
        
        select.glass-input option {
            background-color: #1f2937;
            color: white;
        }

        .day-btn { transition: all 0.2s ease; }
        .day-btn.active {
            background: white;
            color: #e73c7e;
            font-weight: 800;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.1s;
            user-select: none;
            touch-action: manipulation;
        }
        .control-btn:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
            z-index: 50; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        
        #dialogModal { z-index: 200; }
        #cashCounterModal { z-index: 100; }
        #calculatorModal { z-index: 150; }

        .chart-point:hover { cursor: pointer; transform: scale(1.5); transform-origin: center; transition: transform 0.2s; }

        /* Estilos Calendario Manual Compacto */
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            border-radius: 6px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s;
            color: rgba(255,255,255,0.7);
        }
        .calendar-day:hover { background: rgba(255,255,255,0.1); color: white; }
        .calendar-day.selected { font-weight: 800; color: #1a1b26; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .calendar-day.has-data { background: rgba(0, 0, 0, 0.6); color: #86efac; border: 1px solid rgba(255,255,255,0.1); }
        .week-indicator { font-size: 0.6rem; text-transform: uppercase; color: rgba(255,255,255,0.3); text-align: center; margin-bottom: 2px; }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        .chart-zoom-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(15px);
            z-index: 60; display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease;
        }
        .chart-zoom-overlay.open { opacity: 1; pointer-events: auto; }
        
        .chart-zoom-card {
            width: 95%; max-width: 800px;
            height: auto; min-height: 50vh; max-height: 85vh;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px; padding: 24px;
            transform: scale(0.9); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column;
            overflow: hidden; 
        }
        .chart-zoom-overlay.open .chart-zoom-card { transform: scale(1); }
        
        #chartContainer { cursor: auto; } /* Cambiado de zoom-in a auto */

        /* --- ESTILOS CALCULADORA NEON (Para Secci√≥n 2) --- */
        .neon-bg {
            background-color: #0f172a;
            background-image: radial-gradient(ellipse at top, #1e293b, #0a0a0a, #000000);
        }
        .neon-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.1s;
        }
        .neon-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.08); }
        
        .neon-text-gradient {
            background: linear-gradient(to right, #22d3ee, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px rgba(56,189,248,0.5));
        }

        .animate-zoom-in { animation: zoomIn 0.2s ease-out forwards; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Estilos Calculadora Moderna Glass iOS (Para Secci√≥n 3) --- */
        .calc-btn {
            appearance: none; outline: none; border: none;
            background: rgba(255, 255, 255, 0.15); /* Base glass */
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white; font-size: 1.5rem; font-weight: 400;
            border-radius: 50%; /* C√≠rculo perfecto */
            aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: transform 0.1s ease, background 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .calc-btn:active { transform: scale(0.92); background: rgba(255, 255, 255, 0.3); }
        .calc-btn.op { background: rgba(255, 159, 10, 0.85); border-color: rgba(255, 159, 10, 0.4); font-weight: 600; font-size: 1.75rem; }
        .calc-btn.op:active { background: rgba(255, 159, 10, 1); }
        .calc-btn.func { background: rgba(165, 165, 165, 0.4); color: #fff; font-weight: 500; font-size: 1.25rem; }
        .calc-btn.num { background: rgba(51, 51, 51, 0.5); }
        .calc-btn.num:hover { background: rgba(60, 60, 60, 0.6); }
        .calc-btn.zero { grid-column: span 2; aspect-ratio: auto; border-radius: 9999px; justify-content: flex-start; padding-left: 28px; }
    </style>
</head>
<body class="min-h-full p-4 md:p-8 text-white selection:bg-pink-500 selection:text-white">

    <div class="max-w-3xl mx-auto space-y-8 pb-16">
        
        <!-- Encabezado -->
        <header class="text-center space-y-2 pt-6">
            <h1 class="text-5xl font-black tracking-tight drop-shadow-md">Barber<span class="text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-200">App</span></h1>
            <p class="text-white/80 font-medium">Gesti√≥n Financiera & Historial</p>
            <div id="saveIndicator" class="opacity-0 transition-opacity duration-300 text-xs font-bold text-white/90 bg-black/20 inline-flex items-center gap-1 px-3 py-1 rounded-full mt-2 backdrop-blur-sm">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                Guardado
            </div>
        </header>

        <!-- 1. Configuraci√≥n Principal -->
        <section class="glass-panel rounded-3xl p-6 md:p-8 space-y-8">
            <div class="flex items-center gap-3 border-b border-white/10 pb-4 mb-4">
                <span class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">1</span>
                <h2 class="text-xl font-bold text-white">Configuraci√≥n</h2>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="space-y-3">
                    <label class="text-sm font-bold text-white/70 uppercase tracking-wider">Usar precio de referencia:</label>
                    <select id="servicioSelector" class="glass-input w-full rounded-xl p-3 font-medium outline-none cursor-pointer">
                        <option value="12000" data-name="Cortes" selected>Corte ($12.000)</option>
                        <option value="15000" data-name="Cortes + Barba">Corte + Barba ($15.000)</option>
                        <option value="8000" data-name="Barbas">Barba ($8.000)</option>
                        <option value="2000" data-name="Dise√±os">Dise√±os (desde $2.000)</option>
                    </select>
                    <div class="relative group">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 text-xl font-light">$</span>
                        <input type="number" id="precioReferencia" class="save-input glass-input w-full rounded-2xl pl-8 p-4 text-2xl font-bold outline-none transition-all placeholder-white/20" value="12000">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="text-sm font-bold text-white/70 uppercase tracking-wider">Tu Ganancia Objetivo (55%)</label>
                    <div class="relative group">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-white/50 text-xl font-light">$</span>
                        <input type="number" id="metaLiquida" class="save-input glass-input w-full rounded-2xl pl-8 p-4 text-2xl font-bold outline-none transition-all placeholder-white/20" placeholder="Ej: 200000">
                    </div>
                </div>
            </div>

            <div class="space-y-4 pt-4">
                <label class="text-sm font-bold text-white/70 uppercase tracking-wider">D√≠as de Trabajo</label>
                <div class="flex flex-wrap justify-between gap-2" id="daySelectorContainer">
                    <button type="button" data-day="0" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">L</button>
                    <button type="button" data-day="1" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">M</button>
                    <button type="button" data-day="2" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">M</button>
                    <button type="button" data-day="3" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">J</button>
                    <button type="button" data-day="4" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">V</button>
                    <button type="button" data-day="5" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">S</button>
                    <button type="button" data-day="6" class="day-btn w-11 h-11 rounded-xl glass-input font-bold flex items-center justify-center hover:bg-white/10">D</button>
                </div>
            </div>

            <div class="pt-2">
                <button id="calcularBtn" class="w-full bg-white text-pink-600 hover:bg-white/90 font-extrabold py-4 px-6 rounded-2xl text-lg shadow-lg shadow-black/20 transition-all active:scale-95 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    Calcular Plan
                </button>
            </div>
        </section>

        <!-- Error Msg -->
        <div id="error" class="hidden fade-in bg-red-500/80 backdrop-blur-md border border-white/20 text-white p-4 rounded-2xl text-center font-bold shadow-lg">
            ‚ö†Ô∏è Ingres√° una Meta ($) y seleccion√° al menos un d√≠a para empezar.
        </div>

        <!-- 2. Tu Plan (Resultado) -->
        <section id="resultado" class="hidden fade-in space-y-6">
            <div class="glass-panel rounded-3xl p-8 text-center relative overflow-hidden group">
                <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                <h3 class="text-white/60 text-lg mb-2 font-medium">Objetivo Diario de Facturaci√≥n</h3>
                <p class="text-5xl md:text-6xl font-black text-white mb-6 drop-shadow-lg" id="resMetaDiaria">$0</p>
                <div class="inline-flex items-center gap-4 bg-black/20 p-2 pr-6 rounded-full border border-white/10 backdrop-blur-sm">
                    <div class="bg-white text-pink-600 w-12 h-12 rounded-full flex items-center justify-center font-black text-xl shadow-lg" id="resCortesPorDia">0</div>
                    <div class="text-left">
                        <p id="lblServicioMeta" class="text-sm text-white font-bold leading-none">Cortes</p>
                        <p class="text-xs text-white/60 leading-none mt-1">por d√≠a aprox.</p>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-white/10 text-sm">
                    <p class="text-white/80">*Si cumpl√≠s, tu ganancia real ser√°:</p>
                    <div class="flex items-center justify-center gap-2 mt-1">
                        <span id="resGananciaProyectada" class="text-2xl font-bold text-white">$0</span>
                        <span id="resDiferenciaGanancia" class="bg-green-500/20 text-green-300 px-2 py-0.5 rounded text-xs font-bold border border-green-500/30">+ $0 extra</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Seguimiento Diario -->
        <section id="seguimiento" class="hidden fade-in glass-panel rounded-3xl p-6 md:p-8">
            <div class="flex items-center gap-3 border-b border-white/10 pb-4 mb-6">
                <span class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">2</span>
                <h2 class="text-xl font-bold text-white">Seguimiento Real</h2>
            </div>
            <div id="inputsDiasContainer" class="grid grid-cols-1 gap-6 mb-8"></div>
            <div class="bg-black/20 rounded-2xl p-6 border border-white/5 space-y-6 backdrop-blur-sm">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4 pb-6 border-b border-white/10">
                    <div class="text-center sm:text-left">
                        <p class="text-xs text-white/50 uppercase font-bold">Total Facturado</p>
                        <p class="text-3xl font-bold text-white" id="resTotalReal">$0</p>
                    </div>
                    <div class="text-center sm:text-right">
                        <p class="text-xs text-green-300 uppercase font-bold">Tu Ganancia L√≠quida</p>
                        <p class="text-3xl font-bold text-green-400 drop-shadow-sm" id="resGananciaReal">$0</p>
                    </div>
                </div>
                <div id="estadoMetaContainer">
                    <div id="resFaltanteWrapper" class="hidden text-center space-y-4">
                        <div>
                            <p class="text-sm text-white/70">Te falta para el objetivo (Ganancia):</p>
                            <p class="text-4xl font-bold text-white" id="resFaltante">$0</p>
                        </div>
                        <div id="cortesFaltantesWrapper" class="inline-block bg-white/10 px-6 py-2 rounded-full border border-white/10 backdrop-blur-md">
                            <span class="text-sm font-medium">Equivale a facturar <span id="resCortesFaltantes" class="font-bold text-xl mx-1 text-white">0</span> <span id="lblServicioFaltante">Cortes</span> m√°s</span>
                        </div>
                        <div id="promedioFaltanteWrapper" class="pt-2">
                             <p class="text-xs text-white/60">Necesit√°s <span class="text-white font-bold underline">facturar</span> <span id="resPromedioFaltante" class="text-white font-bold">$0</span> en cada d√≠a restante. <span id="resPromedioCortesWrapper" class="block mt-1 text-white/80">(aprox. <span id="resPromedioCortes" class="font-bold text-white">0</span> <span id="lblServicioPromedio">Cortes</span> diarios)</span></p>
                        </div>
                    </div>
                    <div id="mensajeExito" class="hidden text-center py-4">
                        <div class="inline-flex p-4 bg-green-500/20 rounded-full mb-4 border border-green-500/30 shadow-[0_0_20px_rgba(34,197,94,0.3)]">
                            <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <h3 class="text-2xl font-black text-white mb-1">¬°META LOGRADA! üéâ</h3>
                        <p class="text-white/80">Extra generado: <span id="resExtra" class="font-bold text-white">$0</span></p>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n Cerrar Semana -->
            <div class="mt-8 pt-4 border-t border-white/10">
                <button id="resetBtn" class="w-full sm:w-auto mx-auto block glass-input hover:bg-white/10 text-white font-bold py-4 px-8 rounded-2xl transition-all active:scale-95 flex items-center justify-center gap-3 border border-white/20 hover:border-pink-500/50" title="Guardar en historial y limpiar">
                    <svg class="w-5 h-5 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                    Cerrar Semana Actual
                </button>
            </div>
        </section>

        <!-- 4. HISTORIAL Y GR√ÅFICOS -->
        <section id="historySection" class="glass-panel rounded-3xl p-6 md:p-8 space-y-6 select-none">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4 border-b border-white/10 pb-4">
                <div class="flex items-center gap-3">
                    <span class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center font-bold text-sm">3</span>
                    <h2 class="text-xl font-bold text-white">Evoluci√≥n Mensual</h2>
                </div>
                
                <div class="flex items-center gap-3">
                    <button onclick="openManualModal()" class="px-3 py-2 bg-indigo-500/20 border border-indigo-500/50 hover:bg-indigo-500/40 text-indigo-200 rounded-xl text-xs font-bold flex items-center gap-1 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/></svg>
                        Manual
                    </button>

                    <div class="flex items-center gap-2 bg-black/20 px-3 py-2 rounded-xl">
                        <button onclick="changeMonth(-1)" class="text-white/50 hover:text-white transition-colors p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                        <span id="currentMonthDisplay" class="font-bold text-white uppercase tracking-wider text-sm min-w-[110px] text-center">ENERO 2024</span>
                        <button onclick="changeMonth(1)" class="text-white/50 hover:text-white transition-colors p-1"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                    </div>
                </div>
            </div>

            <!-- CHART WRAPPER MODIFICADO: SIN ONCLICK, BOT√ìN AGREGADO -->
            <div class="relative h-72 w-full bg-black/10 rounded-2xl border border-white/5 p-4 flex flex-col justify-end group overflow-hidden transition-all hover:bg-black/20 hover:border-white/10" id="mainChartWrapper">
                <!-- Bot√≥n Expandir -->
                <button onclick="expandChart()" class="absolute top-3 right-3 bg-white/10 hover:bg-white/20 p-2 rounded-xl text-white/70 hover:text-white transition-all z-20 backdrop-blur-md border border-white/5 shadow-lg active:scale-95" title="Ampliar Gr√°fico">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                </button>
                
                <div id="chartContainer" class="w-full h-full relative z-10">
                    <p class="absolute inset-0 flex items-center justify-center text-white/20 text-sm">No hay registros guardados en este mes.<br><span class="text-xs opacity-50">(Desliz√° para ver otros meses)</span></p>
                </div>
                <div class="absolute bottom-0 left-0 w-full px-2 pointer-events-none">
                    <div class="flex w-full text-[10px] text-white/40 uppercase tracking-widest pb-1">
                        <span class="w-1/4 text-center">Sem 1</span>
                        <span class="w-1/4 text-center">Sem 2</span>
                        <span class="w-1/4 text-center">Sem 3</span>
                        <span class="w-1/4 text-center">Sem 4</span>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-xs text-green-300 uppercase font-bold tracking-wider mb-1">Tu Ganancia Mensual</p>
                    <p id="monthUserTotal" class="text-2xl font-bold text-green-400">$0</p>
                </div>
                <div class="bg-white/5 p-4 rounded-2xl border border-white/5 text-center">
                    <p class="text-xs text-white/50 uppercase font-bold tracking-wider mb-1">A la Barber√≠a</p>
                    <p id="monthCompanyTotal" class="text-2xl font-bold text-white">$0</p>
                </div>
            </div>
        </section>

        <!-- 5. ACUMULADO ANUAL -->
        <section class="bg-black/40 border border-white/10 rounded-3xl p-6 md:p-8 backdrop-blur-md">
            <h2 class="text-lg font-bold text-white mb-6 flex items-center gap-2 opacity-80">
                <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                Acumulado Anual (Total Hist√≥rico)
            </h2>
            <div class="flex flex-col md:flex-row gap-6 justify-around items-center">
                <div class="text-center w-full">
                    <p class="text-sm text-white/40 mb-2 uppercase tracking-widest">Total Generado (Bruto)</p>
                    <p id="yearTotalBruto" class="text-4xl font-black text-white">$0</p>
                </div>
                <div class="h-px w-full md:w-px md:h-20 bg-white/10"></div>
                <div class="text-center w-full">
                    <p class="text-sm text-green-400/60 mb-2 uppercase tracking-widest">Tu Bolsillo</p>
                    <p id="yearTotalUser" class="text-4xl font-black text-green-400">$0</p>
                </div>
                <div class="h-px w-full md:w-px md:h-20 bg-white/10"></div>
                <div class="text-center w-full">
                    <p class="text-sm text-white/40 mb-2 uppercase tracking-widest">Empresa</p>
                    <p id="yearTotalCompany" class="text-4xl font-black text-white/60">$0</p>
                </div>
            </div>
        </section>

        <p class="text-center text-white/30 text-xs mt-8 font-medium">Tus datos se guardan en este dispositivo.</p>
    </div>

    <!-- MODAL GR√ÅFICO EXPANDIDO -->
    <div id="chartZoomOverlay" class="chart-zoom-overlay">
        <div class="chart-zoom-card">
            <button onclick="closeExpandedChart()" class="absolute top-4 right-4 bg-white/10 hover:bg-white/20 text-white rounded-full p-2 z-50">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div class="text-center mb-4 pt-2 flex-shrink-0">
                <h2 id="expandedMonthDisplay" class="text-2xl font-bold text-white uppercase tracking-widest">ENERO 2024</h2>
                <p class="text-white/50 text-sm">Desliz√° para navegar</p>
            </div>
            <div class="flex-1 w-full relative min-h-0" id="expandedChartContainer">
                <!-- Se clona el gr√°fico aqu√≠ -->
            </div>
            <div class="flex justify-between w-full text-xs text-white/40 uppercase tracking-widest mt-4 px-2 flex-shrink-0">
                <span class="w-1/4 text-center">Semana 1</span>
                <span class="w-1/4 text-center">Semana 2</span>
                <span class="w-1/4 text-center">Semana 3</span>
                <span class="w-1/4 text-center">Semana 4</span>
            </div>
        </div>
    </div>

    <!-- MODAL CALCULADORA CASH COUNTER (NEON) - PARA SECCI√ìN 2 -->
    <div id="cashCounterModal" class="modal-overlay">
        <div class="neon-bg w-full h-full md:h-auto md:max-h-[90vh] md:max-w-md md:rounded-[32px] overflow-hidden shadow-2xl flex flex-col relative text-white select-none">
            
            <!-- Header -->
            <header class="sticky top-0 z-40 bg-black/30 backdrop-blur-xl border-b border-white/10 shadow-[0_4px_30px_rgba(0,0,0,0.5)] px-4 py-3">
                <div class="flex justify-between items-center mb-1">
                    <div class="flex items-center gap-2 text-cyan-400 drop-shadow-[0_0_5px_rgba(34,211,238,0.8)]">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></svg>
                        <span class="text-xs font-bold tracking-widest uppercase">Total Acumulado</span>
                    </div>
                    
                    <div class="flex gap-2">
                        <button onclick="CashCounter.toggleAddModal()" class="p-1.5 bg-emerald-500/20 hover:bg-emerald-500/40 border border-emerald-500/50 text-emerald-400 rounded-full transition-all active:scale-95 shadow-[0_0_10px_rgba(16,185,129,0.2)]">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                        </button>
                        <button onclick="CashCounter.toggleResetModal()" class="p-1.5 bg-rose-500/20 hover:bg-rose-500/40 border border-rose-500/50 text-rose-400 rounded-full transition-all active:scale-95 shadow-[0_0_10px_rgba(244,63,94,0.2)]">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                        </button>
                        <button onclick="CashCounter.close()" class="p-1.5 bg-white/5 hover:bg-white/20 border border-white/20 text-white rounded-full transition-all active:scale-95">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                    </div>
                </div>
                <div class="text-4xl font-black tracking-tight text-center neon-text-gradient mb-1" id="cashTotalDisplay">
                    $0
                </div>
                <button onclick="CashCounter.applyToInput()" class="w-full bg-white text-black font-bold text-sm py-2 rounded-lg shadow-lg active:scale-95 transition-transform hover:bg-gray-100 flex items-center justify-center gap-2">
                    Aplicar Total
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="text-black"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </button>
            </header>

            <!-- Main Area -->
            <main class="flex-1 p-3 overflow-y-auto custom-scroll" id="cashGridContainer">
                <!-- Grid will be injected here -->
            </main>

            <!-- Footer -->
            <footer class="bg-black/40 backdrop-blur-md border-t border-white/10 p-2 text-center text-[10px] text-white/30 uppercase tracking-widest sticky bottom-0 z-30">
                Calculadora de Servicios
            </footer>

            <!-- Modals Overlay (Nested) -->
            <div id="cashModalsOverlay" class="absolute inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm hidden animate-zoom-in">
                <!-- Reset Modal -->
                <div id="cashResetModal" class="hidden w-full max-w-sm bg-[#1a1b26] border border-white/10 rounded-2xl p-6 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                    <div class="w-12 h-12 bg-rose-500/10 border border-rose-500/20 rounded-full flex items-center justify-center mb-4 mx-auto text-rose-500 shadow-[0_0_15px_rgba(244,63,94,0.2)]">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">¬øReiniciar Todo?</h3>
                    <p class="text-sm text-white/50 mb-6">El contador volver√° a cero.</p>
                    <div class="flex gap-3">
                        <button onclick="CashCounter.hideModals()" class="flex-1 py-3 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10">Cancelar</button>
                        <button onclick="CashCounter.confirmReset()" class="flex-1 py-3 bg-rose-600/80 hover:bg-rose-500 rounded-xl font-bold shadow-[0_0_20px_rgba(225,29,72,0.4)]">S√≠, borrar</button>
                    </div>
                </div>

                <!-- Add Modal -->
                <div id="cashAddModal" class="hidden w-full max-w-sm bg-[#1a1b26] border border-white/10 rounded-2xl p-6 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                    <div class="w-12 h-12 bg-emerald-500/10 border border-emerald-500/20 rounded-full flex items-center justify-center mb-4 mx-auto text-emerald-400 shadow-[0_0_15px_rgba(16,185,129,0.2)]">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">Nuevo Bot√≥n</h3>
                    <input type="number" id="newDenomInput" placeholder="Ej: 50000" class="w-full text-center text-2xl font-bold p-3 bg-black/30 border border-white/10 rounded-xl text-emerald-400 outline-none mb-6 placeholder-white/10">
                    <div class="flex gap-3">
                        <button onclick="CashCounter.hideModals()" class="flex-1 py-3 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10">Cancelar</button>
                        <button onclick="CashCounter.addDenomination()" class="flex-1 py-3 bg-emerald-600/80 hover:bg-emerald-500 rounded-xl font-bold shadow-[0_0_20px_rgba(5,150,105,0.4)]">Agregar</button>
                    </div>
                </div>

                <!-- Delete Modal -->
                <div id="cashDeleteModal" class="hidden w-full max-w-sm bg-[#1a1b26] border border-white/10 rounded-2xl p-6 text-center shadow-[0_0_50px_rgba(0,0,0,0.5)]">
                    <h3 class="text-lg font-bold text-white mb-2">¬øEliminar bot√≥n?</h3>
                    <p class="text-sm text-white/50 mb-6">Vas a quitar el bot√≥n de <strong class="text-rose-400" id="deleteDenomValue"></strong>.</p>
                    <div class="flex gap-3">
                        <button onclick="CashCounter.hideModals()" class="flex-1 py-3 bg-white/5 hover:bg-white/10 rounded-xl border border-white/10">Cancelar</button>
                        <button onclick="CashCounter.confirmDelete()" class="flex-1 py-3 bg-white/10 hover:bg-rose-900/50 text-rose-400 border border-rose-500/30 rounded-xl font-bold">Eliminar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CALCULADORA GLASS iOS - PARA SECCI√ìN 3 (MANUAL) -->
    <div id="calculatorModal" class="modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-[40px] overflow-hidden shadow-2xl backdrop-blur-xl border border-white/20">
            <div class="p-6 pb-2">
                <div class="text-right mb-4">
                    <div id="calcExpression" class="text-white/50 text-sm h-6 font-mono tracking-wide"></div>
                    <div id="calcDisplay" class="text-5xl font-light text-white font-sans tracking-tight leading-none">0</div>
                    <div class="flex justify-end items-center gap-2 mt-2">
                        <span class="text-[10px] text-green-400 font-bold uppercase tracking-wider bg-green-500/10 px-2 py-1 rounded">Tu Ganancia (55%):</span>
                        <span id="calcProfitDisplay" class="text-sm font-bold text-green-400">$0</span>
                    </div>
                </div>
            </div>
            <div class="p-5 pb-8 grid grid-cols-4 gap-3 bg-black/10">
                <button onclick="calcInput('C')" class="calc-btn func">C</button>
                <button onclick="calcInput('DEL')" class="calc-btn func">‚å´</button>
                <button class="calc-btn func pointer-events-none opacity-50"></button> 
                <button onclick="calcInput('/')" class="calc-btn op">√∑</button>
                <button onclick="calcInput('7')" class="calc-btn num">7</button>
                <button onclick="calcInput('8')" class="calc-btn num">8</button>
                <button onclick="calcInput('9')" class="calc-btn num">9</button>
                <button onclick="calcInput('*')" class="calc-btn op">√ó</button>
                <button onclick="calcInput('4')" class="calc-btn num">4</button>
                <button onclick="calcInput('5')" class="calc-btn num">5</button>
                <button onclick="calcInput('6')" class="calc-btn num">6</button>
                <button onclick="calcInput('-')" class="calc-btn op">‚àí</button>
                <button onclick="calcInput('1')" class="calc-btn num">1</button>
                <button onclick="calcInput('2')" class="calc-btn num">2</button>
                <button onclick="calcInput('3')" class="calc-btn num">3</button>
                <button onclick="calcInput('+')" class="calc-btn op">+</button>
                <button onclick="calcInput('0')" class="calc-btn num zero">0</button>
                <button onclick="calcInput('.')" class="calc-btn num">.</button>
                <button onclick="calcInput('=')" class="calc-btn op">=</button>
            </div>
            <div class="px-5 pb-6 flex justify-between gap-3">
                <button onclick="closeCalculator()" class="flex-1 py-3.5 rounded-2xl font-bold text-white/70 hover:bg-white/10 transition-colors text-sm">Cancelar</button>
                <button onclick="applyCalculatorResult()" class="flex-1 py-3.5 rounded-2xl font-bold bg-white text-black hover:bg-gray-100 shadow-lg active:scale-95 transition-transform text-sm">Aplicar</button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DI√ÅLOGO -->
    <div id="dialogModal" class="modal-overlay">
        <div class="glass-panel w-full max-w-sm mx-4 rounded-3xl p-6 text-center transform scale-95 transition-transform duration-200" id="dialogContent">
            <h3 id="dialogTitle" class="text-xl font-bold text-white mb-2">Atenci√≥n</h3>
            <p id="dialogMsg" class="text-white/80 mb-6 text-sm"></p>
            <div class="flex gap-3 justify-center" id="dialogActions"></div>
        </div>
    </div>

    <!-- MODAL MANUAL ENTRY (REDISENADO & COMPACTO) -->
    <div id="manualModal" class="modal-overlay">
        <div class="glass-panel w-full max-w-sm mx-4 rounded-3xl p-5 relative max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-white">Carga Manual</h3>
                <button onclick="closeManualModal()" class="text-white/50 hover:text-white p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Scroll interno para pantallas muy peque√±as -->
            <div class="overflow-y-auto custom-scroll pr-1 -mr-1 flex-1 space-y-3" style="overscroll-behavior: contain;">
                <!-- Fila 1: Fecha y Selectores -->
                <div class="bg-black/10 rounded-xl p-3 border border-white/5">
                    <div class="flex gap-2">
                        <select id="manualMonth" class="glass-input w-2/3 rounded-lg p-2 outline-none cursor-pointer text-sm font-bold"></select>
                        <select id="manualYear" class="glass-input w-1/3 rounded-lg p-2 outline-none cursor-pointer text-sm font-bold"></select>
                    </div>
                </div>

                <!-- Fila 2: Calendario Compacto -->
                <div>
                    <div class="grid grid-cols-7 mb-1 px-1">
                        <div class="week-indicator">L</div><div class="week-indicator">M</div><div class="week-indicator">M</div><div class="week-indicator">J</div><div class="week-indicator">V</div><div class="week-indicator">S</div><div class="week-indicator">D</div>
                    </div>
                    <div id="manualCalendarContainer" class="grid grid-cols-7 gap-1 p-2 bg-black/10 rounded-xl border border-white/5"></div>
                </div>

                <!-- Fila 3: Lista de Semanas (Altura limitada) -->
                <div>
                    <label class="block text-[10px] font-bold text-white/40 mb-1 uppercase tracking-wider">Seleccionar Semana</label>
                    <div id="manualWeeksContainer" class="custom-scroll max-h-32 overflow-y-auto pr-1 space-y-1">
                        <!-- Generado por JS -->
                    </div>
                    <p id="selectedWeekDisplay" class="text-center text-xs font-bold text-white mt-2 h-4 truncate"></p>
                </div>

                <!-- Fila 4: Input Monto -->
                <div>
                    <label class="block text-xs font-bold text-emerald-400 mb-1 ml-1 uppercase">Tu Ganancia ($)</label>
                    <div class="flex items-center gap-2">
                        <!-- BOT√ìN ABRE CALCULADORA IOS -->
                        <button onclick="openCalculator('manualAmount')" class="control-btn w-10 h-10 rounded-xl flex items-center justify-center text-lg font-bold bg-indigo-500/20 border-indigo-500/30 text-indigo-300 hover:bg-indigo-500/40 transition-all flex-shrink-0">
                             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
                        </button>
                        <input type="number" id="manualAmount" class="glass-input w-full rounded-xl p-2.5 font-bold text-lg" placeholder="0">
                    </div>
                </div>
            </div>

            <!-- Bot√≥n Sticky al final -->
            <button id="btnSaveManual" onclick="saveManualEntry()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-xl mt-3 shadow-lg active:scale-95 transition-all text-sm uppercase tracking-wide">
                Guardar
            </button>
        </div>
    </div>

    <!-- L√ìGICA -->
    <script>
        // CONFIGURACI√ìN Y VARIABLES
        let metaLiquidaGoal = 0;
        let precioCorteGoal = 0;
        let diasTrabajoGoal = 0;
        let serviceName = 'Cortes'; 
        const tuPorcentaje = 0.55; 
        const comisionPorcentaje = 0.45; 
        
        const daysNames = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
        let selectedDays = []; 
        const staticIdsToSave = ['precioReferencia', 'metaLiquida'];

        let historyData = []; 
        let currentViewDate = new Date();
        const monthColors = ['#22d3ee', '#f472b6', '#4ade80', '#fbbf24', '#a78bfa', '#fb7185', '#60a5fa', '#f87171', '#34d399', '#818cf8', '#facc15', '#2dd4bf'];

        let currentManualWeeks = [];
        let selectedWeekIndex = -1;
        let isChartExpanded = false;
        let currentCalcInputId = null;
        let savedScrollPosition = 0;

        // --- CASH COUNTER LOGIC (Replaces React App - For Section 2) ---
        const CashCounter = {
            denominations: [60000, 50000, 30000, 20000, 15000, 14000, 12000, 8000, 6000],
            counts: {},
            currentDeleteVal: null,
            targetInputId: null,

            init() {
                const savedDenoms = localStorage.getItem('calc-denoms');
                if (savedDenoms) this.denominations = JSON.parse(savedDenoms);
                const savedCounts = localStorage.getItem('calc-counts');
                if (savedCounts) this.counts = JSON.parse(savedCounts);
            },

            save() {
                localStorage.setItem('calc-denoms', JSON.stringify(this.denominations));
                localStorage.setItem('calc-counts', JSON.stringify(this.counts));
            },

            triggerHaptic() { if (navigator.vibrate) navigator.vibrate(10); },
            format(num) { return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(num); },

            render() {
                const container = document.getElementById('cashGridContainer');
                container.innerHTML = '';
                const total = this.denominations.reduce((acc, val) => acc + (val * (this.counts[val] || 0)), 0);
                document.getElementById('cashTotalDisplay').textContent = this.format(total);

                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-3 max-w-3xl mx-auto pb-4';

                this.denominations.forEach(val => {
                    const count = this.counts[val] || 0;
                    const subtotal = val * count;
                    const isActive = count > 0;
                    const card = document.createElement('div');
                    card.className = `relative h-24 neon-card rounded-xl overflow-hidden group select-none`;
                    card.innerHTML = `
                        <button onclick="CashCounter.askDelete(event, ${val})" class="absolute top-1 right-1 z-30 p-1 text-white/20 hover:text-rose-400 hover:bg-rose-500/10 rounded-full opacity-0 group-hover:opacity-100 transition-all">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </button>
                        <div class="absolute inset-0 flex h-full w-full z-10">
                            <button onclick="CashCounter.update(${val}, -1)" class="w-1/2 h-full flex items-center justify-start pl-3 group/minus active:bg-rose-500/10 outline-none touch-manipulation">
                                <div class="bg-rose-500/10 border border-rose-500/30 text-rose-400 p-1.5 rounded-full opacity-40 group-active/minus:opacity-100 transition-all shadow-[0_0_10px_rgba(244,63,94,0.0)] group-active/minus:shadow-[0_0_10px_rgba(244,63,94,0.4)]">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </div>
                            </button>
                            <button onclick="CashCounter.update(${val}, 1)" class="w-1/2 h-full flex items-center justify-end pr-3 group/plus active:bg-emerald-500/10 outline-none touch-manipulation">
                                <div class="bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 p-1.5 rounded-full opacity-40 group-active/plus:opacity-100 transition-all shadow-[0_0_10px_rgba(16,185,129,0.0)] group-active/plus:shadow-[0_0_10px_rgba(16,185,129,0.4)]">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                </div>
                            </button>
                        </div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-0">
                            <span class="text-2xl font-bold text-white tracking-wide drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]">${val.toLocaleString('es-AR')}</span>
                            <div class="mt-1 px-2.5 py-0.5 rounded-full text-xs font-bold transition-all border-b border-t border-transparent ${isActive ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.2)]' : 'bg-white/5 text-white/30 border-white/5'}">
                                ${count}
                            </div>
                            <span class="text-[10px] text-cyan-200/70 font-medium mt-1 tracking-wider h-4">${isActive ? this.format(subtotal) : ''}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });

                const addBtn = document.createElement('button');
                addBtn.onclick = () => this.toggleAddModal();
                addBtn.className = "h-24 rounded-xl border border-dashed border-white/20 bg-white/5 flex flex-col items-center justify-center text-white/40 hover:text-emerald-400 hover:border-emerald-500/50 hover:bg-emerald-500/5 transition-all group";
                addBtn.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mb-1 opacity-50 group-hover:opacity-100 group-hover:drop-shadow-[0_0_8px_rgba(16,185,129,0.6)] transition-all"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
                    <span class="text-xs font-medium tracking-wide">NUEVO</span>
                `;
                grid.appendChild(addBtn);
                container.appendChild(grid);
            },

            update(val, delta) {
                const current = this.counts[val] || 0;
                if (current + delta < 0) return;
                this.counts[val] = current + delta;
                this.triggerHaptic();
                this.save();
                this.render();
            },

            open(inputId) {
                this.targetInputId = inputId;
                this.render();
                toggleBodyLock(true);
                document.getElementById('cashCounterModal').classList.add('open');
            },

            close() {
                toggleBodyLock(false);
                document.getElementById('cashCounterModal').classList.remove('open');
            },
            
            applyToInput() {
                if(this.targetInputId) {
                    let total = this.denominations.reduce((acc, val) => acc + (val * (this.counts[val] || 0)), 0);
                    const input = document.getElementById(this.targetInputId);
                    if(input) {
                        input.value = Math.round(total);
                        input.dispatchEvent(new Event('input'));
                    }
                }
                this.close();
            },

            hideModals() {
                document.getElementById('cashModalsOverlay').classList.add('hidden');
                document.getElementById('cashResetModal').classList.add('hidden');
                document.getElementById('cashAddModal').classList.add('hidden');
                document.getElementById('cashDeleteModal').classList.add('hidden');
            },

            toggleResetModal() {
                this.hideModals();
                document.getElementById('cashModalsOverlay').classList.remove('hidden');
                document.getElementById('cashResetModal').classList.remove('hidden');
            },

            confirmReset() {
                this.counts = {};
                this.denominations.forEach(d => this.counts[d] = 0);
                this.save();
                this.render();
                this.hideModals();
                this.triggerHaptic();
            },

            toggleAddModal() {
                this.hideModals();
                document.getElementById('newDenomInput').value = '';
                document.getElementById('cashModalsOverlay').classList.remove('hidden');
                document.getElementById('cashAddModal').classList.remove('hidden');
                setTimeout(() => document.getElementById('newDenomInput').focus(), 100);
            },

            addDenomination() {
                const val = parseInt(document.getElementById('newDenomInput').value);
                if (val > 0 && !this.denominations.includes(val)) {
                    this.denominations.push(val);
                    this.denominations.sort((a,b) => b-a);
                    this.counts[val] = 0;
                    this.save();
                    this.render();
                    this.triggerHaptic();
                }
                this.hideModals();
            },

            askDelete(e, val) {
                e.stopPropagation();
                this.currentDeleteVal = val;
                this.hideModals();
                document.getElementById('deleteDenomValue').textContent = '$' + val.toLocaleString();
                document.getElementById('cashModalsOverlay').classList.remove('hidden');
                document.getElementById('cashDeleteModal').classList.remove('hidden');
                this.triggerHaptic();
            },

            confirmDelete() {
                if (this.currentDeleteVal) {
                    this.denominations = this.denominations.filter(d => d !== this.currentDeleteVal);
                    delete this.counts[this.currentDeleteVal];
                    this.save();
                    this.render();
                    this.triggerHaptic();
                }
                this.hideModals();
            }
        };

        // --- CALCULADORA iOS (Para Secci√≥n 3) ---
        let calcExpression = '';
        let calcResult = 0;

        function openCalculator(targetId) {
            currentCalcInputId = targetId;
            calcExpression = '';
            calcResult = 0;
            updateCalcDisplay();
            toggleBodyLock(true);
            document.getElementById('calculatorModal').classList.add('open');
        }

        function closeCalculator() {
            document.getElementById('calculatorModal').classList.remove('open');
            toggleBodyLock(false);
        }

        function calcInput(val) {
            if (val === 'C') {
                calcExpression = '';
                calcResult = 0;
            } else if (val === 'DEL') {
                calcExpression = calcExpression.toString().slice(0, -1);
            } else if (val === '=') {
                try {
                    const result = eval(calcExpression.replace(/[^-()\d/*+.]/g, ''));
                    calcResult = result || 0;
                    calcExpression = String(calcResult);
                } catch {
                    calcExpression = 'Error';
                    calcResult = 0;
                }
            } else {
                calcExpression += val;
                try {
                    const tempExp = calcExpression.replace(/[^-()\d/*+.]/g, '');
                    if (!['+', '-', '*', '/'].includes(tempExp.slice(-1))) {
                         calcResult = eval(tempExp) || 0;
                    }
                } catch {}
            }
            updateCalcDisplay();
        }

        function updateCalcDisplay() {
            document.getElementById('calcExpression').textContent = calcExpression;
            document.getElementById('calcDisplay').textContent = formatCurrency(calcResult);
            // Mostrar siempre el 55% proyectado para que el usuario sepa qu√© se aplicar√°
            document.getElementById('calcProfitDisplay').textContent = formatCurrency(calcResult * tuPorcentaje);
        }

        function applyCalculatorResult() {
            if(currentCalcInputId && calcResult > 0) {
                let valueToApply = calcResult;
                // SI es carga manual, aplicamos el 55%
                if(currentCalcInputId === 'manualAmount') {
                    valueToApply = calcResult * tuPorcentaje;
                }
                const input = document.getElementById(currentCalcInputId);
                if(input) {
                    // FIX: Redondear al entero m√°s cercano para evitar decimales como 5.98
                    input.value = Math.round(valueToApply);
                    input.dispatchEvent(new Event('input'));
                }
            }
            closeCalculator();
        }

        // --- FUNCIONES DE CONTROL DE SCROLL ---
        function toggleBodyLock(isLocked) {
            const body = document.body;
            if (isLocked) {
                // Guardar la posici√≥n actual antes de fijar el body
                savedScrollPosition = window.scrollY;
                body.style.top = `-${savedScrollPosition}px`;
                body.classList.add('no-scroll');
            } else {
                // Restaurar
                body.classList.remove('no-scroll');
                body.style.removeProperty('top');
                window.scrollTo(0, savedScrollPosition);
            }
        }

        // --- FUNCIONES UTILITARIAS DE FECHA ---
        function getMonday(d) {
            d = new Date(d);
            var day = d.getDay(),
                diff = d.getDate() - day + (day == 0 ? -6 : 1); 
            return new Date(d.setDate(diff));
        }

        function addDays(date, days) {
            var result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function formatDateShort(date) {
            return new Intl.DateTimeFormat('es-AR', { day: 'numeric', month: 'short' }).format(date);
        }

        function generateWeeksForMonth(year, month) {
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            let currentMonday = getMonday(firstDayOfMonth);
            const weeks = [];
            let weekIndex = 1;

            while (currentMonday <= lastDayOfMonth) {
                const endOfWeek = addDays(currentMonday, 6);
                endOfWeek.setHours(23, 59, 59, 999);
                const label = `${formatDateShort(currentMonday)} ‚Äì ${formatDateShort(endOfWeek)}`;
                weeks.push({
                    index: weekIndex,
                    start: new Date(currentMonday),
                    end: new Date(endOfWeek),
                    label: label
                });
                currentMonday = addDays(currentMonday, 7);
                weekIndex++;
            }
            return weeks;
        }

        const formatCurrency = (num) => {
            if (isNaN(num) || num === null) return '$0';
            return new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS', maximumFractionDigits: 0 }).format(num);
        };

        const showSaveIndicator = () => {
            const indicator = document.getElementById('saveIndicator');
            indicator.classList.remove('opacity-0');
            setTimeout(() => { indicator.classList.add('opacity-0'); }, 1500);
        };
        
        function showDialog(title, msg, onConfirm, onCancel, confirmText = "Aceptar", cancelText = "Cancelar") {
            const modal = document.getElementById('dialogModal');
            const content = document.getElementById('dialogContent');
            const titleEl = document.getElementById('dialogTitle');
            const msgEl = document.getElementById('dialogMsg');
            const actionsEl = document.getElementById('dialogActions');
            
            titleEl.textContent = title;
            msgEl.textContent = msg;
            actionsEl.innerHTML = '';

            if (onCancel || !onConfirm) { 
                const btnCancel = document.createElement('button');
                btnCancel.className = "px-6 py-2 rounded-xl text-white/70 hover:bg-white/10 font-medium transition-colors border border-transparent";
                btnCancel.textContent = onConfirm ? cancelText : "Cerrar";
                btnCancel.onclick = () => {
                    modal.classList.remove('open');
                    setTimeout(() => { content.classList.remove('scale-100'); content.classList.add('scale-95'); }, 200);
                    toggleBodyLock(false); 
                    if (onCancel) onCancel();
                };
                actionsEl.appendChild(btnCancel);
            }

            if (onConfirm) {
                const btnConfirm = document.createElement('button');
                btnConfirm.className = "px-6 py-2 rounded-xl bg-white text-pink-600 font-bold hover:bg-gray-100 transition-colors shadow-lg";
                btnConfirm.textContent = confirmText;
                btnConfirm.onclick = () => {
                    modal.classList.remove('open');
                    setTimeout(() => { content.classList.remove('scale-100'); content.classList.add('scale-95'); }, 200);
                    toggleBodyLock(false); 
                    onConfirm();
                };
                actionsEl.appendChild(btnConfirm);
            }
            
            toggleBodyLock(true); 
            modal.classList.add('open');
            setTimeout(() => { content.classList.remove('scale-95'); content.classList.add('scale-100'); }, 10);
        }

        // GESTI√ìN DE DATOS
        function saveData(event) {
            const target = event.target || event;
            if (target.id) {
                localStorage.setItem(target.id, target.value);
                showSaveIndicator();
            }
        }

        function loadAllData() {
            CashCounter.init(); // Init Cash Counter
            
            const savedHistory = localStorage.getItem('barber_history');
            if (savedHistory) historyData = JSON.parse(savedHistory);
            
            staticIdsToSave.forEach(id => {
                const element = document.getElementById(id);
                const savedVal = localStorage.getItem(id);
                if (element && savedVal) element.value = savedVal;
            });
            
            const savedDays = localStorage.getItem('selectedDaysStorage');
            if (savedDays) {
                selectedDays = JSON.parse(savedDays);
            } else {
                selectedDays = [1, 2, 3, 4, 5]; 
                localStorage.setItem('selectedDaysStorage', JSON.stringify(selectedDays));
            }
            updateDayButtonsVisuals();
            
            const savedServiceName = localStorage.getItem('serviceName');
            if(savedServiceName) {
                serviceName = savedServiceName;
                const options = document.getElementById('servicioSelector').options;
                for(let i=0; i<options.length; i++) {
                    if(options[i].getAttribute('data-name') === serviceName) {
                        document.getElementById('servicioSelector').selectedIndex = i;
                        break;
                    }
                }
            }
            
            renderHistorySection();
            setupSwipeGestures();

            const metaVal = parseFloat(document.getElementById('metaLiquida').value);
            const precioRefVal = parseFloat(document.getElementById('precioReferencia').value);

            if (metaVal > 0 && precioRefVal > 0 && selectedDays.length > 0) {
                performCalculation();
            }
        }
        
        function saveSelectedDays() {
            localStorage.setItem('selectedDaysStorage', JSON.stringify(selectedDays));
            showSaveIndicator();
        }

        function updateDayButtonsVisuals() {
            const buttons = document.querySelectorAll('.day-btn');
            buttons.forEach(btn => {
                const dayIndex = parseInt(btn.getAttribute('data-day'));
                if (selectedDays.includes(dayIndex)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function updateServiceLabels() {
            const labels = [
                document.getElementById('lblServicioMeta'),
                document.getElementById('lblServicioFaltante'),
                document.getElementById('lblServicioPromedio')
            ];
            labels.forEach(lbl => { if(lbl) lbl.textContent = serviceName; });
        }

        // --- SWIPE LOGIC FIXED ---
        function changeMonth(delta) {
            currentViewDate.setMonth(currentViewDate.getMonth() + delta);
            renderHistorySection();
        }

        function setupSwipeGestures() {
            const targets = [document.getElementById('historySection'), document.getElementById('chartZoomOverlay')];
            targets.forEach(section => {
                let touchStartX = 0;
                let touchStartY = 0;
                
                section.addEventListener('touchstart', e => { 
                    touchStartX = e.changedTouches[0].screenX; 
                    touchStartY = e.changedTouches[0].screenY;
                }, {passive: true});
                
                section.addEventListener('touchend', e => { 
                    let touchEndX = e.changedTouches[0].screenX; 
                    let touchEndY = e.changedTouches[0].screenY;
                    handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY); 
                }, {passive: true});
            });
        }

        function handleSwipe(startX, startY, endX, endY) {
            const threshold = 50; 
            const diffX = endX - startX;
            const diffY = endY - startY;
            if (Math.abs(diffX) > Math.abs(diffY)) {
                if (Math.abs(diffX) > threshold) {
                    if (diffX < 0) changeMonth(1); 
                    else changeMonth(-1); 
                }
            }
        }

        function expandChart() {
            isChartExpanded = true;
            document.getElementById('chartZoomOverlay').classList.add('open');
            toggleBodyLock(true);
            renderHistorySection(); 
        }

        function closeExpandedChart() {
            isChartExpanded = false;
            document.getElementById('chartZoomOverlay').classList.remove('open');
            toggleBodyLock(false);
        }

        function renderHistorySection() {
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const currentMonthIdx = currentViewDate.getMonth();
            const currentYear = currentViewDate.getFullYear();
            
            const displayText = `${monthNames[currentMonthIdx]} ${currentYear}`;
            document.getElementById('currentMonthDisplay').textContent = displayText;
            document.getElementById('expandedMonthDisplay').textContent = displayText; 

            const monthlyData = historyData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getFullYear() === currentYear && itemDate.getMonth() === currentMonthIdx;
            });

            const prevMonthDate = new Date(currentViewDate);
            prevMonthDate.setMonth(prevMonthDate.getMonth() - 1);
            const prevMonthIdx = prevMonthDate.getMonth();
            const prevYear = prevMonthDate.getFullYear();

            const prevMonthlyData = historyData.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate.getFullYear() === prevYear && itemDate.getMonth() === prevMonthIdx;
            });

            renderChart(monthlyData, prevMonthlyData, currentMonthIdx, prevMonthIdx, document.getElementById('chartContainer'));
            renderChart(monthlyData, prevMonthlyData, currentMonthIdx, prevMonthIdx, document.getElementById('expandedChartContainer'));

            const monthBruto = monthlyData.reduce((acc, curr) => acc + curr.totalBruto, 0);
            const monthUser = monthBruto * tuPorcentaje;
            const monthCompany = monthBruto * comisionPorcentaje;

            document.getElementById('monthUserTotal').textContent = formatCurrency(monthUser);
            document.getElementById('monthCompanyTotal').textContent = formatCurrency(monthCompany);

            const yearBruto = historyData.reduce((acc, curr) => acc + curr.totalBruto, 0);
            const yearUser = yearBruto * tuPorcentaje;
            const yearCompany = yearBruto * comisionPorcentaje;

            document.getElementById('yearTotalBruto').textContent = formatCurrency(yearBruto);
            document.getElementById('yearTotalUser').textContent = formatCurrency(yearUser);
            document.getElementById('yearTotalCompany').textContent = formatCurrency(yearCompany);
        }

        function renderChart(currentData, prevData, currentMonthIdx, prevMonthIdx, container) {
            container.innerHTML = '';

            if (currentData.length === 0 && prevData.length === 0) {
                container.innerHTML = '<p class="absolute inset-0 flex items-center justify-center text-white/20 text-sm">No hay registros.<br><span class="text-xs opacity-50">Desliz√° para ver m√°s.</span></p>';
                return;
            }

            const maxValCurrent = Math.max(...currentData.map(d => d.netUser), 0);
            const maxValPrev = Math.max(...prevData.map(d => d.netUser), 0);
            const maxVal = Math.max(maxValCurrent, maxValPrev) || 1;

            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute("width", "100%");
            svg.setAttribute("height", "100%");
            svg.setAttribute("viewBox", `0 0 100 100`);
            svg.setAttribute("preserveAspectRatio", "none");
            svg.style.overflow = 'visible';

            const gridLines = [0, 25, 50, 75, 100];
            gridLines.forEach(y => {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", "0"); line.setAttribute("y1", y);
                line.setAttribute("x2", "100"); line.setAttribute("y2", y);
                line.setAttribute("stroke", "rgba(255,255,255,0.05)");
                line.setAttribute("stroke-width", "0.5");
                svg.appendChild(line);
            });

            const getXForDate = (isoDate) => {
                const d = new Date(isoDate);
                const day = d.getDate();
                if (day <= 7) return 12.5;
                if (day <= 14) return 37.5;
                if (day <= 21) return 62.5;
                return 87.5; 
            };

            const getPoints = (data) => {
                let points = "";
                data.forEach((item) => {
                    const x = getXForDate(item.date);
                    const heightPerc = (item.netUser / maxVal) * 80;
                    const y = 100 - heightPerc;
                    points += `${x},${y} `;
                });
                return points;
            };

            if (prevData.length > 0) {
                prevData.sort((a,b) => new Date(a.date) - new Date(b.date));
                const prevPoints = getPoints(prevData);
                const prevLine = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                prevLine.setAttribute("points", prevPoints);
                prevLine.setAttribute("fill", "none");
                prevLine.setAttribute("stroke", monthColors[prevMonthIdx]);
                prevLine.setAttribute("stroke-width", "1.5"); 
                prevLine.setAttribute("stroke-opacity", "0.3");
                prevLine.setAttribute("stroke-dasharray", "4");
                svg.appendChild(prevLine);
            }

            if (currentData.length > 0) {
                currentData.sort((a,b) => new Date(a.date) - new Date(b.date));
                const currentColor = monthColors[currentMonthIdx];
                const currentPoints = getPoints(currentData);
                
                currentData.forEach((item) => {
                    const x = getXForDate(item.date);
                    const heightPerc = (item.netUser / maxVal) * 80;
                    const y = 100 - heightPerc;

                    const pointWrapper = document.createElement('div');
                    pointWrapper.className = 'absolute group flex flex-col items-center pointer-events-auto chart-point';
                    pointWrapper.style.left = `${x}%`;
                    pointWrapper.style.bottom = `${heightPerc}%`;
                    pointWrapper.style.transform = 'translateX(-50%)'; 
                    pointWrapper.style.marginBottom = '-6px'; 

                    const d = new Date(item.date);
                    const weekNum = getWeekOfMonth(d);
                    
                    pointWrapper.innerHTML = `
                        <div class="absolute bottom-full mb-2 opacity-0 group-hover:opacity-100 transition-opacity bg-black/90 border border-white/10 text-white text-[10px] p-2 rounded whitespace-nowrap z-10 pointer-events-none shadow-xl">
                            <span class="text-white/50 uppercase font-bold tracking-wider">Sem ${weekNum} (${d.getDate()}/${d.getMonth()+1})</span><br>
                            <span style="color:${currentColor}" class="font-bold text-sm">${formatCurrency(item.netUser)}</span>
                        </div>
                        <div class="w-3 h-3 bg-white rounded-full border-2 shadow-lg group-hover:scale-150 transition-transform cursor-pointer" style="border-color:${currentColor}"></div>
                    `;
                    container.appendChild(pointWrapper);
                });

                if (currentData.length > 1) {
                    const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
                    polyline.setAttribute("points", currentPoints);
                    polyline.setAttribute("fill", "none");
                    polyline.setAttribute("stroke", currentColor);
                    polyline.setAttribute("stroke-width", "3");
                    polyline.setAttribute("filter", "drop-shadow(0 0 4px " + currentColor + "80)"); 
                    
                    const firstX = getXForDate(currentData[0].date);
                    const lastX = getXForDate(currentData[currentData.length-1].date);
                    const polygonPoints = `${firstX},100 ${currentPoints} ${lastX},100`;

                    const polygon = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                    polygon.setAttribute("points", polygonPoints);
                    
                    const gradId = "grad" + currentMonthIdx + Math.random().toString(36).substr(2, 9); 
                    let defs = svg.querySelector('defs');
                    if(!defs) {
                        defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");
                        svg.appendChild(defs);
                    }
                    const gradient = document.createElementNS("http://www.w3.org/2000/svg", "linearGradient");
                    gradient.id = gradId;
                    gradient.setAttribute("x1", "0%"); gradient.setAttribute("y1", "0%");
                    gradient.setAttribute("x2", "0%"); gradient.setAttribute("y2", "100%");
                    gradient.innerHTML = `<stop offset="0%" style="stop-color:${currentColor};stop-opacity:0.3" /><stop offset="100%" style="stop-color:${currentColor};stop-opacity:0" />`;
                    defs.appendChild(gradient);
                    polygon.setAttribute("fill", `url(#${gradId})`);
                    
                    svg.appendChild(polygon);
                    svg.appendChild(polyline);
                }
            }

            container.appendChild(svg);
        }

        // --- INTERFAZ DIN√ÅMICA ---

        function generarInputsDias() {
            const container = document.getElementById('inputsDiasContainer');
            container.innerHTML = ''; 
            
            const sortedDays = [...selectedDays].sort((a, b) => a - b);
            if (sortedDays.length === 0) return;

            sortedDays.forEach(dayIndex => {
                const dayName = daysNames[dayIndex];
                const inputId = `dia_${dayName}`; 
                
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col space-y-1';
                
                const label = document.createElement('label');
                label.setAttribute('for', inputId);
                label.className = 'block text-xs font-bold text-white/60 ml-1';
                label.textContent = dayName.toUpperCase();
                
                const controlsContainer = document.createElement('div');
                controlsContainer.className = 'flex items-center gap-2';

                // BOT√ìN CALCULADORA SECCI√ìN 2 (ABRE CASH COUNTER)
                const btnCalc = document.createElement('button');
                btnCalc.className = 'control-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold bg-indigo-500/20 border-indigo-500/30 text-indigo-300 hover:bg-indigo-500/40 hover:text-white transition-all shadow-[0_0_10px_rgba(99,102,241,0.1)]';
                btnCalc.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>';
                btnCalc.onclick = () => CashCounter.open(inputId);

                const btnMinus = document.createElement('button');
                btnMinus.className = 'control-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold';
                btnMinus.innerHTML = '&minus;';
                
                const btnPlus = document.createElement('button');
                btnPlus.className = 'control-btn w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold';
                btnPlus.innerHTML = '&plus;';
                
                const inputContainer = document.createElement('div');
                inputContainer.className = 'relative flex-1';
                const symbol = document.createElement('span');
                symbol.className = 'absolute left-3 top-1/2 -translate-y-1/2 text-white/40';
                symbol.textContent = '$';
                const input = document.createElement('input');
                input.type = 'number';
                input.id = inputId;
                input.className = 'dia-input glass-input w-full rounded-xl pl-7 p-3 outline-none font-bold text-center transition-all';
                input.placeholder = "0";
                
                const savedVal = localStorage.getItem(inputId);
                if (savedVal) input.value = savedVal;

                input.addEventListener('input', (e) => { saveData(e); actualizarSeguimiento(); });
                setupLongPress(btnMinus, input, -500);
                setupLongPress(btnPlus, input, 500);

                inputContainer.appendChild(symbol);
                inputContainer.appendChild(input);
                controlsContainer.appendChild(btnCalc);
                controlsContainer.appendChild(btnMinus);
                controlsContainer.appendChild(inputContainer);
                controlsContainer.appendChild(btnPlus);
                wrapper.appendChild(label);
                wrapper.appendChild(controlsContainer);
                container.appendChild(wrapper);
            });
        }
        
        function setupLongPress(button, input, step) {
            let interval;
            let timeout;
            const modifyValue = () => {
                let current = parseFloat(input.value) || 0;
                current += step;
                if(current < 0) current = 0;
                input.value = current;
                input.dispatchEvent(new Event('input'));
            };
            const start = (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                modifyValue(); 
                timeout = setTimeout(() => { interval = setInterval(modifyValue, 40); }, 300); 
            };
            const stop = () => { clearTimeout(timeout); clearInterval(interval); };
            button.addEventListener('mousedown', start);
            button.addEventListener('mouseup', stop);
            button.addEventListener('mouseleave', stop);
            button.addEventListener('touchstart', start);
            button.addEventListener('touchend', stop);
            button.addEventListener('touchcancel', stop);
        }

        // L√ìGICA DE C√ÅLCULO
        function performCalculation() {
            const precioRef = parseFloat(document.getElementById('precioReferencia').value) || 0;
            const metaLiquida = parseFloat(document.getElementById('metaLiquida').value) || 0;
            const countDias = selectedDays.length;
            
            const errorDiv = document.getElementById('error');
            const resultadoDiv = document.getElementById('resultado');
            const seguimientoDiv = document.getElementById('seguimiento');

            if (metaLiquida <= 0 || precioRef <= 0 || countDias <= 0) return;

            errorDiv.classList.add('hidden');
            metaLiquidaGoal = metaLiquida;
            precioCorteGoal = precioRef; 
            diasTrabajoGoal = countDias;

            const totalFacturar = metaLiquida / tuPorcentaje;
            const metaDiariaFacturar = totalFacturar / diasTrabajoGoal;
            const cortesPorDia = Math.ceil(metaDiariaFacturar / precioCorteGoal); 
            const facturacionDiariaAprox = cortesPorDia * precioCorteGoal;
            const facturacionSemanalAprox = facturacionDiariaAprox * diasTrabajoGoal;
            const gananciaLiquidaAprox = facturacionSemanalAprox * tuPorcentaje;
            const diferencia = gananciaLiquidaAprox - metaLiquida;

            document.getElementById('resMetaDiaria').textContent = formatCurrency(metaDiariaFacturar);
            document.getElementById('resCortesPorDia').textContent = cortesPorDia;
            document.getElementById('resGananciaProyectada').textContent = formatCurrency(gananciaLiquidaAprox);
            
            const diffEl = document.getElementById('resDiferenciaGanancia');
            if(diferencia > 0) {
                diffEl.textContent = `+ ${formatCurrency(diferencia)} extra`;
                diffEl.classList.remove('hidden');
            } else { diffEl.textContent = 'Exacto'; }
            
            updateServiceLabels();
            resultadoDiv.classList.remove('hidden');
            seguimientoDiv.classList.remove('hidden');
            generarInputsDias(); 
            actualizarSeguimiento();
        }

        function actualizarSeguimiento() {
            metaLiquidaGoal = parseFloat(document.getElementById('metaLiquida').value) || 0;
            precioCorteGoal = parseFloat(document.getElementById('precioReferencia').value) || 0;
            diasTrabajoGoal = selectedDays.length;

            const diasInputs = document.querySelectorAll('.dia-input');
            let totalFacturadoReal = 0;
            let diasCargados = 0;

            diasInputs.forEach(input => {
                const val = parseFloat(input.value) || 0;
                totalFacturadoReal += val;
                if (val > 0) diasCargados++;
            });

            const gananciaLiquidaReal = totalFacturadoReal * tuPorcentaje;
            const faltante = metaLiquidaGoal - gananciaLiquidaReal;

            document.getElementById('resTotalReal').textContent = formatCurrency(totalFacturadoReal);
            document.getElementById('resGananciaReal').textContent = formatCurrency(gananciaLiquidaReal);

            const faltanteWrapper = document.getElementById('resFaltanteWrapper');
            const exitoDiv = document.getElementById('mensajeExito');
            const cortesWrapper = document.getElementById('cortesFaltantesWrapper');
            const cortesSpan = document.getElementById('resCortesFaltantes');
            const promedioWrapper = document.getElementById('promedioFaltanteWrapper');
            const promedioSpan = document.getElementById('resPromedioFaltante');
            const promedioCortesSpan = document.getElementById('resPromedioCortes');
            
            updateServiceLabels();

            if (faltante > 100) { 
                exitoDiv.classList.add('hidden'); 
                faltanteWrapper.classList.remove('hidden');
                document.getElementById('resFaltante').textContent = formatCurrency(faltante);

                if (precioCorteGoal > 0) {
                    const faltanteBruto = faltante / tuPorcentaje;
                    const cortesFaltantes = Math.ceil(faltanteBruto / precioCorteGoal);
                    cortesSpan.textContent = cortesFaltantes;
                    cortesWrapper.classList.remove('hidden');
                } else { cortesWrapper.classList.add('hidden'); }

                let diasRestantesCalculo = diasTrabajoGoal - diasCargados;
                if (diasRestantesCalculo <= 0) diasRestantesCalculo = 0;

                if (diasRestantesCalculo > 0) {
                    const faltanteBruto = faltante / tuPorcentaje; 
                    const metaDiariaRestanteBruta = faltanteBruto / diasRestantesCalculo;
                    const serviciosDiariosRestantes = Math.ceil(metaDiariaRestanteBruta / precioCorteGoal);
                    promedioSpan.textContent = formatCurrency(metaDiariaRestanteBruta);
                    if(promedioCortesSpan) promedioCortesSpan.textContent = serviciosDiariosRestantes;
                    promedioWrapper.classList.remove('hidden');
                } else { promedioWrapper.classList.add('hidden'); }

            } else {
                faltanteWrapper.classList.add('hidden');
                exitoDiv.classList.remove('hidden');
                const extra = gananciaLiquidaReal - metaLiquidaGoal;
                document.getElementById('resExtra').textContent = formatCurrency(Math.max(0, extra));
            }
        }

        // EVENTOS
        document.getElementById('servicioSelector').addEventListener('change', function() {
            const precio = this.value;
            const input = document.getElementById('precioReferencia');
            input.value = precio;
            const selectedOption = this.options[this.selectedIndex];
            serviceName = selectedOption.getAttribute('data-name') || 'Cortes';
            localStorage.setItem('serviceName', serviceName);
            input.dispatchEvent(new Event('input'));
            if(document.getElementById('metaLiquida').value) performCalculation();
        });

        document.querySelectorAll('.save-input').forEach(input => { input.addEventListener('input', saveData); });
        document.querySelectorAll('.day-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const dayIndex = parseInt(this.getAttribute('data-day'));
                if (selectedDays.includes(dayIndex)) selectedDays = selectedDays.filter(d => d !== dayIndex);
                else selectedDays.push(dayIndex);
                saveSelectedDays();
                updateDayButtonsVisuals();
            });
        });

        document.getElementById('calcularBtn').addEventListener('click', function() {
            if (selectedDays.length === 0) {
                document.getElementById('error').classList.remove('hidden');
                return;
            }
            performCalculation();
            document.getElementById('resultado').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });

        // NUEVO: L√ìGICA INTELIGENTE DE CIERRE DE SEMANA
        function saveToHistory(totalBruto) {
            // Guardar con fecha actual
            const entry = {
                date: new Date().toISOString(),
                totalBruto: totalBruto,
                netUser: totalBruto * tuPorcentaje,
                company: totalBruto * comisionPorcentaje
            };
            historyData.push(entry);
            localStorage.setItem('barber_history', JSON.stringify(historyData));
            renderHistorySection(); 
        }

        function resetUI() {
            daysNames.forEach(day => localStorage.removeItem(`dia_${day}`));
            const inputsDias = document.querySelectorAll('.dia-input');
            inputsDias.forEach(input => input.value = '');
            actualizarSeguimiento();
        }

        document.getElementById('resetBtn').addEventListener('click', function() {
            const diasInputs = document.querySelectorAll('.dia-input');
            let totalBruto = 0;
            diasInputs.forEach(input => { totalBruto += parseFloat(input.value) || 0; });
            
            // Verificar Meta
            const gananciaReal = totalBruto * tuPorcentaje;
            const meta = parseFloat(document.getElementById('metaLiquida').value) || 0;

            if (totalBruto > 0) {
                if (gananciaReal >= meta && meta > 0) {
                    saveToHistory(totalBruto);
                    showDialog("¬°Felicitaciones! üéâ", "Meta superada. La semana se ha guardado autom√°ticamente en tu historial.", () => {
                         resetUI();
                    }, null, "Genial");
                } else {
                    showDialog("Meta no alcanzada", "No alcanzaste la meta esta semana. ¬øQuer√©s guardar este registro en tu historial de todos modos?", 
                    () => { // S√ç, guardar
                        saveToHistory(totalBruto);
                        resetUI();
                    }, 
                    () => { // NO, preguntar si borrar
                         showDialog("¬øBorrar sin guardar?", "Se perder√°n los datos de esta semana permanentemente.", 
                         () => { // S√ç borrar
                             resetUI();
                         }, null, "Borrar", "Cancelar");
                    }, "Guardar", "No guardar");
                }
            } else {
                showDialog("Reiniciar", "¬øReiniciar semana? No hay datos ingresados.", () => resetUI(), null, "S√≠", "Cancelar");
            }
        });

        // --- HELPER: Calcular Semana de Calendario ---
        function getWeekOfMonth(date) {
            const d = new Date(date);
            const dateNum = d.getDate();
            const year = d.getFullYear();
            const month = d.getMonth();
            
            const firstDay = new Date(year, month, 1);
            let dayOfWeek = firstDay.getDay(); // 0 Sun, 1 Mon...
            // Convertir a Lunes=0, ..., Dom=6
            let isoDay = (dayOfWeek === 0) ? 6 : dayOfWeek - 1;
            
            // F√≥rmula: (Dia del mes + Desplazamiento del 1ro - 1) / 7 + 1
            return Math.floor((dateNum + isoDay - 1) / 7) + 1;
        }

        // FUNCIONES MODAL MANUAL
        function openManualModal() {
            const selectMonth = document.getElementById('manualMonth');
            const selectYear = document.getElementById('manualYear');
            
            selectMonth.innerHTML = '';
            selectYear.innerHTML = '';
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const currentY = new Date().getFullYear();
            const today = new Date();

            for (let i = currentY - 1; i <= currentY + 1; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = i;
                if(i === currentY) opt.selected = true;
                selectYear.appendChild(opt);
            }

            monthNames.forEach((name, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = name;
                if(i === today.getMonth()) opt.selected = true;
                selectMonth.appendChild(opt);
            });
            
            selectMonth.onchange = updateManualWeeksState;
            selectYear.onchange = updateManualWeeksState;

            document.getElementById('manualAmount').value = '';
            
            updateManualWeeksState(); 
            toggleBodyLock(true); // LOCK SCROLL
            document.getElementById('manualModal').classList.add('open');
        }

        function updateManualWeeksState() {
            const month = parseInt(document.getElementById('manualMonth').value);
            const year = parseInt(document.getElementById('manualYear').value);
            
            currentManualWeeks = generateWeeksForMonth(year, month);
            renderManualCalendar(year, month);
            
            const btnContainer = document.getElementById('manualWeeksContainer');
            btnContainer.innerHTML = '';
            
            currentManualWeeks.forEach((week, idx) => {
                const btn = document.createElement('button');
                btn.className = "manual-week-btn w-full p-2 mb-1 rounded-lg glass-input hover:bg-white/20 text-left transition-all flex justify-between items-center group text-xs";
                
                const entry = getExistingEntryForWeek(week.start, week.end);
                let statusBadge = '';
                
                if (entry) {
                    btn.classList.add('border-emerald-500/30');
                    statusBadge = `<span class="text-emerald-400 text-[10px] font-bold bg-emerald-500/10 px-1.5 py-0.5 rounded border border-emerald-500/20">‚úì</span>`;
                }

                btn.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-[9px] text-white/50 font-bold uppercase tracking-wider">SEM ${week.index}</span>
                        <span class="text-xs font-bold text-white group-hover:text-indigo-200 transition-colors">${week.label}</span>
                    </div>
                    ${statusBadge}
                `;
                
                btn.onclick = () => selectManualWeek(idx);
                btnContainer.appendChild(btn);
            });

            selectManualWeek(0); 
        }

        function renderManualCalendar(year, month) {
            const container = document.getElementById('manualCalendarContainer');
            container.innerHTML = '';
            
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = new Date(year, month, 1).getDay(); 
            const startOffset = (firstDayIndex === 0 ? 6 : firstDayIndex - 1);

            for(let i=0; i<startOffset; i++) {
                container.appendChild(document.createElement('div'));
            }

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month, d);
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day relative';
                dayEl.textContent = d;
                
                const weekIndex = currentManualWeeks.findIndex(w => dateObj >= w.start && dateObj <= w.end);
                
                if (weekIndex !== -1) {
                    const week = currentManualWeeks[weekIndex];
                    if (getExistingEntryForWeek(week.start, week.end)) {
                        dayEl.classList.add('has-data');
                    }
                }
                
                dayEl.onclick = () => {
                    if (weekIndex !== -1) selectManualWeek(weekIndex);
                };
                
                container.appendChild(dayEl);
            }
        }

        function getExistingEntryForWeek(weekStart, weekEnd) {
            return historyData.find(item => {
                const d = new Date(item.date);
                return d >= weekStart && d <= weekEnd;
            });
        }

        function selectManualWeek(index) {
            if (index < 0 || index >= currentManualWeeks.length) return;
            
            selectedWeekIndex = index;
            const week = currentManualWeeks[index];
            const month = parseInt(document.getElementById('manualMonth').value);
            const color = monthColors[month % monthColors.length];

            const btns = document.getElementById('manualWeeksContainer').children;
            Array.from(btns).forEach((btn, i) => {
                if(i === index) {
                    btn.classList.add('bg-indigo-600', 'border-indigo-500', 'shadow-lg');
                    btn.classList.remove('glass-input', 'hover:bg-white/20');
                } else {
                    btn.classList.remove('bg-indigo-600', 'border-indigo-500', 'shadow-lg');
                    btn.classList.add('glass-input', 'hover:bg-white/20');
                }
            });

            const days = document.querySelectorAll('.calendar-day');
            const daysInMonth = new Date(document.getElementById('manualYear').value, month + 1, 0).getDate();
            
            days.forEach(dayEl => {
                if (!dayEl.textContent) return; 
                const d = parseInt(dayEl.textContent);
                const dateObj = new Date(document.getElementById('manualYear').value, month, d);
                
                if (dateObj >= week.start && dateObj <= week.end) {
                    dayEl.classList.add('selected');
                    dayEl.style.backgroundColor = color;
                    dayEl.style.color = '#1f2937';
                } else {
                    dayEl.classList.remove('selected');
                     if(dayEl.classList.contains('has-data')) {
                        dayEl.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
                        dayEl.style.color = '#86efac';
                    } else {
                        dayEl.style.backgroundColor = 'transparent';
                        dayEl.style.color = 'rgba(255,255,255,0.7)';
                    }
                }
            });

            const display = document.getElementById('selectedWeekDisplay');
            display.innerHTML = `SEMANA ${week.index}: <span style="font-weight:400; opacity:0.8">${week.label}</span>`;
            display.style.color = color;

            const entry = getExistingEntryForWeek(week.start, week.end);
            const inputAmount = document.getElementById('manualAmount');
            const saveBtn = document.getElementById('btnSaveManual');
            
            if (entry) {
                inputAmount.value = entry.netUser;
                saveBtn.textContent = "Actualizar Registro";
                saveBtn.classList.add('bg-emerald-600', 'hover:bg-emerald-500');
                saveBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
            } else {
                inputAmount.value = '';
                saveBtn.textContent = "Guardar Nuevo Registro";
                saveBtn.classList.remove('bg-emerald-600', 'hover:bg-emerald-500');
                saveBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            }
        }

        function closeManualModal() {
            document.getElementById('manualModal').classList.remove('open');
            toggleBodyLock(false); // UNLOCK SCROLL
        }

        function saveManualEntry() {
            if (selectedWeekIndex === -1) return;

            const week = currentManualWeeks[selectedWeekIndex];
            const userProfit = parseFloat(document.getElementById('manualAmount').value);
            
            if(!userProfit || userProfit <= 0) {
                showDialog("Atenci√≥n", "Ingres√° un monto v√°lido.");
                return;
            }

            const totalBruto = userProfit / tuPorcentaje;

            const existingEntryIndex = historyData.findIndex(item => {
                const d = new Date(item.date);
                return d >= week.start && d <= week.end;
            });
            
            const performSave = () => {
                if (existingEntryIndex !== -1) {
                   historyData.splice(existingEntryIndex, 1);
                }
                const entry = {
                    date: week.start.toISOString(),
                    totalBruto: totalBruto,
                    netUser: userProfit,
                    company: totalBruto * comisionPorcentaje
                };
                
                historyData.push(entry);
                localStorage.setItem('barber_history', JSON.stringify(historyData));
                
                renderHistorySection();
                closeManualModal();
                showDialog("√âxito", "Registro guardado exitosamente.", null, null, "Ok");
            };

            if (existingEntryIndex !== -1) {
                const existingAmount = formatCurrency(historyData[existingEntryIndex].netUser);
                showDialog("Confirmar Sobrescritura", 
                    `Ya existe un registro para esta semana (${week.label}) con una ganancia de ${existingAmount}.\n\n¬øDeseas SOBRESCRIBIRLO con el nuevo valor de $${userProfit}?`, 
                    performSave, null, "S√≠, sobrescribir");
            } else {
                performSave();
            }
        }

        // INICIALIZACI√ìN
        loadAllData();
    </script>
</body>
</html>


